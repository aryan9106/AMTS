{% extends 'my_amts/base.html' %}
{% load static %}

{% block title %}Emergency Dashboard - AMTS{% endblock %}

{% block extra_css %}
<style>
    .emergency-dashboard {
        background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
        min-height: 100vh;
        padding: 20px 0;
    }
    
    .emergency-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        padding: 30px;
        margin-bottom: 20px;
    }
    
    .emergency-header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
    }
    
    .emergency-header h1 {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 10px;
    }
    
    .emergency-btn {
        background: linear-gradient(45deg, #f44336, #d32f2f);
        border: none;
        color: white;
        padding: 15px 30px;
        font-size: 1.2rem;
        font-weight: bold;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(244, 67, 54, 0.4);
        transition: all 0.3s ease;
        width: 100%;
        margin-bottom: 15px;
    }
    
    .emergency-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(244, 67, 54, 0.6);
        color: white;
    }
    
    .emergency-btn:active {
        transform: translateY(0);
    }
    
    .emergency-btn.processing {
        background: linear-gradient(45deg, #ff9800, #f57c00);
        cursor: not-allowed;
    }
    
    .bus-selector {
        margin-bottom: 20px;
    }
    
    .bus-selector select {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 1.1rem;
    }
    
    .location-input {
        margin-bottom: 20px;
    }
    
    .location-input input {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        margin-bottom: 10px;
    }
    
    .emergency-status {
        display: none;
        padding: 20px;
        border-radius: 10px;
        margin-top: 20px;
        font-weight: bold;
    }
    
    .status-success {
        background: #e8f5e8;
        border: 2px solid #4caf50;
        color: #2e7d32;
    }
    
    .status-error {
        background: #ffebee;
        border: 2px solid #f44336;
        color: #c62828;
    }
    
    .status-processing {
        background: #fff3e0;
        border: 2px solid #ff9800;
        color: #ef6c00;
    }
    
    .notification-summary {
        background: #f5f5f5;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
    }
    
    .notification-summary h5 {
        color: #1a237e;
        margin-bottom: 10px;
    }
    
    .notification-item {
        display: flex;
        justify-content: space-between;
        padding: 5px 0;
        border-bottom: 1px solid #ddd;
    }
    
    .notification-item:last-child {
        border-bottom: none;
    }
    
    .pulse-animation {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    .emergency-icon {
        font-size: 3rem;
        margin-bottom: 20px;
        animation: flash 1s infinite;
    }
    
    @keyframes flash {
        0%, 50% { opacity: 1; }
        25%, 75% { opacity: 0.5; }
    }
    
    .info-card {
        background: #e3f2fd;
        border: 1px solid #2196f3;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .info-card h6 {
        color: #1976d2;
        margin-bottom: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="emergency-dashboard">
    <div class="container">
        <div class="emergency-header">
            <div class="emergency-icon">üö®</div>
            <h1>EMERGENCY ACCIDENT ALERT SYSTEM</h1>
            <p class="lead">AMTS Emergency Response Dashboard</p>
            {% if emergency_count > 0 %}
            <div class="alert alert-danger mt-3">
                <h5>‚ö†Ô∏è ACTIVE EMERGENCIES: {{ emergency_count }}</h5>
                <p class="mb-0">{{ emergency_count }} bus{{ emergency_count|pluralize:"es" }} currently in emergency state</p>
            </div>
            {% endif %}
        </div>
        
        <div class="row justify-content-center">
            {% if active_emergencies %}
            <div class="col-md-10 mb-4">
                <div class="emergency-card">
                    <h3 class="text-center mb-4 text-danger">üö® ACTIVE EMERGENCIES</h3>
                    
                    {% for emergency in active_emergencies %}
                    <div class="alert alert-danger mb-3">
                        <div class="row">
                            <div class="col-md-8">
                                <h6 class="mb-2">üöå Bus {{ emergency.bus.bus_number }} - ACCIDENT DETECTED</h6>
                                <p class="mb-1"><strong>üìç Location:</strong> {{ emergency.current_location }}</p>
                                <p class="mb-1"><strong>‚è∞ Status:</strong> {{ emergency.status }}</p>
                                <p class="mb-1"><strong>üïí Last Updated:</strong> {{ emergency.last_updated|date:"M d, Y H:i" }}</p>
                                {% if emergency.latitude and emergency.longitude %}
                                <p class="mb-0">
                                    <strong>üó∫Ô∏è GPS:</strong> 
                                    <a href="https://www.google.com/maps?q={{ emergency.latitude }},{{ emergency.longitude }}" target="_blank" class="text-white">
                                        {{ emergency.latitude }}, {{ emergency.longitude }} (View on Maps)
                                    </a>
                                </p>
                                {% endif %}
                            </div>
                            <div class="col-md-4 text-end">
                                <span class="badge bg-danger fs-6">EMERGENCY ACTIVE</span>
                                <br><small class="text-muted">Speed: {{ emergency.speed }} km/h</small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    
                    <div class="text-center mt-3">
                        <button class="btn btn-warning" onclick="window.location.reload()">
                            üîÑ Refresh Emergency Status
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <div class="col-md-8">
                <div class="emergency-card">
                    <h3 class="text-center mb-4">üöå Bus Accident Emergency Protocol</h3>
                    
                    <div class="info-card">
                        <h6>üìã Emergency System Features:</h6>
                        <ul class="mb-0">
                            <li>‚úÖ Instantly freeze bus at GPS location</li>
                            <li>‚úÖ Send emergency broadcast to ALL registered users</li>
                            <li>‚úÖ Notify all passengers with bookings on the bus</li>
                            <li>‚úÖ Alert emergency helplines and control room</li>
                            <li>‚úÖ Generate Google Maps location link</li>
                            <li>‚úÖ Log all notifications for audit trail</li>
                        </ul>
                    </div>
                    
                    <form id="emergencyForm">
                        <div class="bus-selector">
                            <label for="busNumber" class="form-label"><strong>üöå Select Bus Number:</strong></label>
                            <select id="busNumber" class="form-select" required>
                                <option value="">Choose a bus...</option>
                                <option value="45">Bus 45 (Paldi ‚Üî Maninagar)</option>
                                <option value="101">Bus 101 (Ahmedabad Railway Station ‚Üî Sarkhej)</option>
                                <option value="130">Bus 130 (Iscon ‚Üî Vatva)</option>
                                <option value="42">Bus 42 (Bopal ‚Üî Kalupur)</option>
                                <option value="85">Bus 85 (Satellite ‚Üî CTM)</option>
                            </select>
                        </div>
                        
                        <div class="location-input">
                            <label class="form-label"><strong>üìç Accident Location:</strong></label>
                            <input type="text" id="accidentLocation" class="form-control" 
                                   placeholder="e.g., Near Paldi Bus Stop, Ahmedabad" required>
                            <input type="number" id="latitude" class="form-control" 
                                   placeholder="Latitude (e.g., 23.0225)" step="any" required>
                            <input type="number" id="longitude" class="form-control" 
                                   placeholder="Longitude (e.g., 72.5714)" step="any" required>
                        </div>
                        
                        <button type="submit" id="emergencyBtn" class="emergency-btn">
                            üö® TRIGGER EMERGENCY ALERT SYSTEM üö®
                        </button>
                        
                        <div class="text-center mt-3">
                            <small class="text-muted">
                                ‚ö†Ô∏è This will immediately send emergency notifications to ALL registered users
                            </small>
                        </div>
                    </form>
                    
                    <div id="emergencyStatus" class="emergency-status">
                        <div id="statusContent"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row justify-content-center mt-4">
            <div class="col-md-8">
                <div class="emergency-card">
                    <h4 class="text-center mb-4">üß™ Test Emergency System</h4>
                    <p class="text-center">Use the button below to test the system with sample data:</p>
                    
                    <button id="testBtn" class="btn btn-outline-primary w-100 mb-3">
                        üß™ Run Test with Sample Data
                    </button>
                    
                    <div class="info-card">
                        <h6>üìß Email Configuration (Localhost):</h6>
                        <p class="mb-1"><strong>Backend:</strong> Console (emails logged to terminal)</p>
                        <p class="mb-1"><strong>Emergency Helplines:</strong> 6 configured addresses</p>
                        <p class="mb-0"><strong>Broadcast Users:</strong> ALL registered users with email</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const emergencyForm = document.getElementById('emergencyForm');
    const emergencyBtn = document.getElementById('emergencyBtn');
    const emergencyStatus = document.getElementById('emergencyStatus');
    const statusContent = document.getElementById('statusContent');
    const testBtn = document.getElementById('testBtn');
    
    // Test button functionality
    testBtn.addEventListener('click', function() {
        document.getElementById('busNumber').value = '45';
        document.getElementById('accidentLocation').value = 'Near Paldi Bus Stop, Ahmedabad';
        document.getElementById('latitude').value = '23.0225';
        document.getElementById('longitude').value = '72.5714';
        
        // Trigger the emergency alert
        triggerEmergencyAlert();
    });
    
    emergencyForm.addEventListener('submit', function(e) {
        e.preventDefault();
        triggerEmergencyAlert();
    });
    
    function triggerEmergencyAlert() {
        const busNumber = document.getElementById('busNumber').value;
        const accidentLocation = document.getElementById('accidentLocation').value;
        const latitude = document.getElementById('latitude').value;
        const longitude = document.getElementById('longitude').value;
        
        if (!busNumber || !accidentLocation || !latitude || !longitude) {
            showStatus('error', '‚ùå Please fill in all fields');
            return;
        }
        
        // Show processing status
        emergencyBtn.classList.add('processing');
        emergencyBtn.innerHTML = 'üîÑ ACTIVATING EMERGENCY SYSTEM...';
        emergencyBtn.disabled = true;
        
        showStatus('processing', 'üö® Emergency system activating...<br>üìß Sending notifications...');
        
        // Send emergency alert
        fetch('/api/emergency-accident/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                bus_number: busNumber,
                accident_location: accidentLocation,
                latitude: parseFloat(latitude),
                longitude: parseFloat(longitude)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const response = data.emergency_response;
                const details = data.accident_details;
                
                let successHtml = `
                    <h5>‚úÖ EMERGENCY SYSTEM ACTIVATED SUCCESSFULLY</h5>
                    <div class="notification-summary">
                        <h6>üìä Notification Summary:</h6>
                        <div class="notification-item">
                            <span>üìß Total Emails Sent:</span>
                            <strong>${response.notifications_sent}</strong>
                        </div>
                        <div class="notification-item">
                            <span>üë• Affected Passengers:</span>
                            <strong>${response.affected_passengers}</strong>
                        </div>
                        <div class="notification-item">
                            <span>üìß Broadcast Alerts:</span>
                            <strong>${response.broadcast_alerts_sent || response.family_alerts_sent}</strong>
                        </div>
                        <div class="notification-item">
                            <span>üö® Helpline Alerts:</span>
                            <strong>${response.helpline_alerts_sent}</strong>
                        </div>
                        <div class="notification-item">
                            <span>üöå Bus Status:</span>
                            <strong>${response.bus_status}</strong>
                        </div>
                        <div class="notification-item">
                            <span>üìç Location Frozen:</span>
                            <strong>${response.location_frozen ? 'YES' : 'NO'}</strong>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <h6>üö® Accident Details:</h6>
                        <p><strong>Bus:</strong> ${details.bus_number}</p>
                        <p><strong>Route:</strong> ${details.route}</p>
                        <p><strong>Location:</strong> ${details.location}</p>
                        <p><strong>Time:</strong> ${details.timestamp}</p>
                        <p><strong>Maps:</strong> <a href="${details.maps_link}" target="_blank">View on Google Maps</a></p>
                    </div>
                    
                    <div class="mt-4 text-center">
                        <div class="alert alert-info">
                            <h6>üö® Refreshing Emergency Dashboard...</h6>
                            <p class="mb-0">Page will refresh in <span id="countdown">5</span> seconds to show emergency status</p>
                            <button id="redirectNow" class="btn btn-primary btn-sm mt-2">Refresh Now</button>
                        </div>
                    </div>
                `;
                
                showStatus('success', successHtml);
                
                // Show success animation
                emergencyBtn.classList.remove('processing');
                emergencyBtn.classList.add('pulse-animation');
                emergencyBtn.innerHTML = '‚úÖ EMERGENCY SYSTEM ACTIVATED';
                
                // Start countdown and redirect
                startRedirectCountdown();
                
            } else {
                showStatus('error', `‚ùå Emergency system failed: ${data.message}`);
                resetButton();
            }
        })
        .catch(error => {
            console.error('Emergency system error:', error);
            showStatus('error', `‚ùå System error: ${error.message}`);
            resetButton();
        });
    }
    
    function startRedirectCountdown() {
        let countdown = 5;
        const countdownElement = document.getElementById('countdown');
        const redirectButton = document.getElementById('redirectNow');
        
        // Update countdown every second
        const countdownInterval = setInterval(() => {
            countdown--;
            if (countdownElement) {
                countdownElement.textContent = countdown;
            }
            
            if (countdown <= 0) {
                clearInterval(countdownInterval);
                redirectToEmergencyDashboard();
            }
        }, 1000);
        
        // Allow immediate redirect
        if (redirectButton) {
            redirectButton.addEventListener('click', () => {
                clearInterval(countdownInterval);
                redirectToEmergencyDashboard();
            });
        }
    }
    
    function redirectToEmergencyDashboard() {
        // Show redirect message
        showStatus('processing', 'üö® Refreshing Emergency Dashboard...');
        
        // Refresh the current page to show updated emergency status
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    }
    
    function showStatus(type, message) {
        emergencyStatus.style.display = 'block';
        emergencyStatus.className = `emergency-status status-${type}`;
        statusContent.innerHTML = message;
        
        // Scroll to status
        emergencyStatus.scrollIntoView({ behavior: 'smooth' });
    }
    
    function resetButton() {
        emergencyBtn.classList.remove('processing', 'pulse-animation');
        emergencyBtn.innerHTML = 'üö® TRIGGER EMERGENCY ALERT SYSTEM üö®';
        emergencyBtn.disabled = false;
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}