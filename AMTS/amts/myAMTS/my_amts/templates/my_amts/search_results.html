<!-- my_amts/templates/search_results.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AMTS - Ahmedabad Bus Services</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-polylinedecorator/1.6.0/leaflet.polylineDecorator.min.js"></script>
    <!-- Add this in the head section -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <style>
        .hero {
            position: relative;
            height: 600px;
            overflow: hidden;
            color: white;
        }

        #map {
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 0;
        }

        .hero-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1;
            background: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 10px;
            width: 60%;
            max-width: 600px;
            transition: top 0.5s ease-in-out, transform 0.5s ease-in-out;
        }

        .hero-content.collapsed {
            top: 100%;
            /* Move it completely out of view */
            transform: translate(-50%, 0%);
            opacity: 0;
            /* Make it invisible */
            pointer-events: none;
            /* Disable interactions */
            transition: top 0.5s ease-in-out, opacity 0.5s ease-in-out;
        }


        .hero-arrow {
            position: absolute;
            bottom: 10px;
            /* Adjusted to align properly */
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            cursor: pointer;
            font-size: 24px;
            color: black;
            z-index: 2;
        }


        .feature-card {
            transition: transform 0.3s;
            cursor: pointer;
        }

        .feature-card:hover {
            transform: translateY(-5px);
        }

        .search-box {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);

        }

        .route-part {
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .transfer-point {
            color: #dc3545;
            font-weight: bold;
            padding: 5px 0;
        }

        .route-details {
            margin: 15px 0;
        }

        .stop-popup {
            padding: 5px;
            text-align: center;
        }

        .text-danger {
            color: #dc3545;
        }

        .leaflet-popup-content {
            margin: 8px;
        }

        .custom-div-icon {
            background: none;
            border: none;
        }

        .bus-marker {
            background: none;
            border: none;
        }

        .modal-dialog.modal-xl {
            max-width: 95%;
            margin: 1.75rem auto;
            height: 90vh;
        }

        .modal-content {
            height: 100%;
        }

        .modal-body {
            position: relative;
            padding: 0;
            height: calc(100% - 56px);
            /* Subtract header height */
            overflow: hidden;
        }

        #trackingMap {
            height: 100% !important;
            width: 100% !important;
            min-height: 500px;
            position: relative;
            z-index: 1;
        }

        .row.g-0 {
            height: 100%;
        }

        .col-md-9,
        .col-md-3 {
            height: 100%;
        }

        .tracking-status {
            height: 70vh;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
            border-left: 1px solid #dee2e6;
        }

        .tracking-status h6 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #2196F3;
        }

        .status-box {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .status-box strong {
            color: #495057;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-box div {
            font-size: 1.1rem;
            margin: 8px 0;
            padding: 8px;
            border-radius: 4px;
        }

        .status-box small {
            display: block;
            margin-top: 5px;
            font-size: 0.85rem;
        }

        #currentLocation {
            background-color: rgba(40, 167, 69, 0.1);
            color: #28a745;
            border-left: 4px solid #28a745;
        }

        #nextStop {
            background-color: rgba(23, 162, 184, 0.1);
            color: #17a2b8;
            border-left: 4px solid #17a2b8;
        }

        #boardingPoint {
            background-color: rgba(0, 123, 255, 0.1);
            color: #007bff;
            border-left: 4px solid #007bff;
        }

        #destinationPoint {
            background-color: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border-left: 4px solid #dc3545;
        }

        .bus-option {
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .bus-option:hover {
            background-color: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .bus-option.selected {
            border-color: #2196F3;
            background-color: #e3f2fd;
        }

        .bus-option h6 {
            margin-bottom: 5px;
            color: #2196F3;
        }

        .bus-details {
            font-size: 0.9rem;
            color: #666;
        }

        .bus-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .status-ontime {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .status-delayed {
            background-color: #fff3e0;
            color: #ef6c00;
        }

        .direction-indicator {
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
            margin: 8px 0;
            background-color: rgba(0, 0, 0, 0.05);
        }

        .direction-header {
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }

        .direction-header h6 {
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .direction-header p {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2196F3;
        }

        .route-info {
            padding-top: 8px;
            border-top: 1px solid #eee;
        }

        .bus-icon {
            background-color: #4CAF50;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            transition: transform 0.3s ease;
        }

        .status-panel {
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .location-info {
            padding: 10px;
            margin: 5px 0;
            border-left: 4px solid #17a2b8;
            background: rgba(23, 162, 184, 0.1);
        }

        .stop-marker {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
        }

        .custom-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            padding: 18px 28px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 15px;
            transform: translateX(120%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 380px;
            min-width: 320px;
        }

        .custom-notification.show {
            transform: translateX(0);
        }

        /* Info notifications - Semi-transparent Blue */
        .custom-notification.info {
            background: rgba(33, 150, 243, 0.15);
            border: 1px solid rgba(33, 150, 243, 0.3);
            box-shadow: 0 8px 32px rgba(33, 150, 243, 0.2);
        }

        /* Success notifications - Semi-transparent Green */
        .custom-notification.success {
            background: rgba(76, 175, 80, 0.15);
            border: 1px solid rgba(76, 175, 80, 0.4);
            box-shadow: 0 8px 32px rgba(76, 175, 80, 0.25);
        }

        /* Error notifications - Semi-transparent Red */
        .custom-notification.error {
            background: rgba(244, 67, 54, 0.15);
            border: 1px solid rgba(244, 67, 54, 0.4);
            box-shadow: 0 8px 32px rgba(244, 67, 54, 0.25);
            animation: shake 0.5s ease-in-out;
        }

        /* Warning notifications - Semi-transparent Orange */
        .custom-notification.warning {
            background: rgba(255, 152, 0, 0.15);
            border: 1px solid rgba(255, 152, 0, 0.4);
            box-shadow: 0 8px 32px rgba(255, 152, 0, 0.25);
        }

        /* Emergency notifications - Semi-transparent Red with pulsing */
        .custom-notification.emergency {
            background: rgba(211, 47, 47, 0.2);
            border: 1px solid rgba(211, 47, 47, 0.5);
            box-shadow: 0 8px 32px rgba(211, 47, 47, 0.3);
            animation: emergencyPulse 1.2s ease-in-out infinite alternate;
        }

        .notification-icon {
            font-size: 28px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.3));
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: bold;
            margin-bottom: 6px;
            font-size: 1.1rem;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .notification-message {
            font-size: 0.9rem;
            opacity: 0.95;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            line-height: 1.4;
        }

        .notification-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: rgba(255, 255, 255, 0.4);
            width: 100%;
            border-radius: 0 0 12px 12px;
            animation: progressBar 5s linear forwards;
        }

        /* Enhanced animations */
        @keyframes progressBar {
            from { width: 100%; }
            to { width: 0%; }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }

        @keyframes emergencyPulse {
            0% { 
                box-shadow: 0 8px 32px rgba(211, 47, 47, 0.3);
                transform: translateX(0) scale(1);
                border-color: rgba(211, 47, 47, 0.5);
            }
            100% { 
                box-shadow: 0 12px 40px rgba(211, 47, 47, 0.5);
                transform: translateX(0) scale(1.02);
                border-color: rgba(211, 47, 47, 0.7);
            }
        }

        /* Hover effects for notifications */
        .custom-notification:hover {
            transform: translateX(-5px) scale(1.02);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }

        .custom-notification.success:hover {
            box-shadow: 0 12px 40px rgba(76, 175, 80, 0.4);
        }

        .custom-notification.error:hover,
        .custom-notification.emergency:hover {
            box-shadow: 0 12px 40px rgba(244, 67, 54, 0.4);
        }

        .custom-notification.warning:hover {
            box-shadow: 0 12px 40px rgba(255, 152, 0, 0.4);
        }

        .custom-notification.info:hover {
            box-shadow: 0 12px 40px rgba(33, 150, 243, 0.4);
        }
            transform-origin: left;
            animation: progress 5s linear;
        }

        @keyframes progress {
            from {
                transform: scaleX(1);
            }

            to {
                transform: scaleX(0);
            }
        }

        /* Update the suggestions styling */
        .suggestions-container {
            position: absolute;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
            margin-top: 5px;
            scrollbar-width: thin;
            scrollbar-color: #90a4ae #f5f5f5;
        }

        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #f0f0f0;
            color: #333;
            /* Added text color */
            font-size: 14px;
            /* Added font size */
            background: white;
            /* Added background */
        }

        .suggestion-item:hover {
            background-color: #f5f9ff;
            padding-left: 20px;
            color: #2196F3;
            /* Change text color on hover */
        }

        .suggestion-item.highlighted {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .suggestion-item::before {
            content: "üöè";
            margin-right: 10px;
            font-size: 1.1em;
        }

        /* Style for no suggestions */
        .no-suggestions {
            padding: 15px;
            text-align: center;
            color: #757575;
            font-style: italic;
            background: white;
            /* Added background */
        }

        /* Make sure input field has proper styling */
        .search-input input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            color: #333;
            /* Added text color */
            background: white;
            /* Added background */
        }

        .search-input input:focus {
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
            outline: none;
        }

        /* Ticket Booking Modal Styles */
        #ticketBookingModal .modal-content {
            border-radius: 16px;
            border: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        #ticketBookingModal .modal-header {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            border-radius: 16px 16px 0 0;
            padding: 1.5rem;
        }

        #ticketBookingModal .modal-body {
            padding: 2rem;
        }

        #ticketBookingForm .form-label {
            font-weight: 500;
            color: #37474F;
            margin-bottom: 0.5rem;
        }

        #ticketBookingForm .form-control {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: 2px solid #E0E0E0;
            transition: all 0.3s ease;
        }

        #ticketBookingForm .form-control:focus {
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .passenger-info {
            background: #F5F7FA;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }

        .passenger-info h6 {
            color: #1976D2;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .fare-breakdown {
            background: #E3F2FD;
            padding: 1.5rem;
            border-radius: 12px;
            margin-top: 1.5rem;
        }

        .fare-breakdown h6 {
            color: #1976D2;
            margin-bottom: 1rem;
        }

        .fare-breakdown ul li {
            padding: 0.5rem 0;
            color: #37474F;
        }

        /* Payment Modal Styles */
        #paymentModal .modal-content {
            border-radius: 16px;
            border: none;
        }

        #paymentForm {
            padding: 2rem;
        }

        #paymentForm .form-label {
            font-weight: 500;
            color: #37474F;
        }

        .card-input-group {
            position: relative;
            margin-bottom: 1.5rem;
        }

        #cardNumber {
            padding-left: 3rem;
            font-family: monospace;
            letter-spacing: 0.5px;
        }

        .card-input-group::before {
            content: 'üí≥';
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
        }

        #cardExpiry,
        #cardCvv {
            font-family: monospace;
        }

        /* Ticket Display Modal Styles */
        #ticketModal .modal-content {
            border-radius: 16px;
            background: #F5F7FA;
        }

        .ticket-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            display: flex;
            gap: 2rem;
        }

        .qr-code {
            flex: 0 0 auto;
            padding: 1rem;
            background: #F8F9FA;
            border-radius: 8px;
            text-align: center;
        }

        .qr-code img {
            max-width: 150px;
            height: auto;
        }

        .ticket-details {
            flex: 1;
        }

        .ticket-details h6 {
            color: #1976D2;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .ticket-details p {
            margin-bottom: 0.5rem;
            color: #37474F;
        }

        /* Download Button Styles */
        .download-btn {
            background: #2196F3;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .download-btn:hover {
            background: #1976D2;
            transform: translateY(-2px);
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .ticket-card {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .qr-code {
                margin-bottom: 1rem;
            }
        }

        /* Add these styles to your existing CSS */
        .is-invalid {
            border-color: #dc3545 !important;
        }

        .invalid-feedback {
            display: block;
            width: 100%;
            margin-top: 0.25rem;
            font-size: 0.875em;
            color: #dc3545;
        }

        .passenger-info {
            position: relative;
            padding-top: 2rem;
        }

        .passenger-info.has-error {
            border: 1px solid #dc3545;
            background-color: #fff8f8;
        }

        /* Navbar Styling */
        .navbar {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%) !important;
            padding: 1rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            animation: slideDown 0.5s ease;
        }

        .navbar-brand {
            display: flex;
            /* Add this */
            align-items: center;
            /* Add this */
            font-size: 1.8rem;
            font-weight: 700;
            color: white !important;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }

        .navbar-brand .bus-icon {
            font-size: 2rem;
            margin-right: 10px;
            animation: bounce 2s infinite;
        }

        .navbar-brand:hover {
            transform: scale(1.05);
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.95) !important;
            font-weight: 500;
            padding: 0.8rem 1.5rem !important;
            transition: all 0.3s ease;
            border-radius: 10px;
            margin: 0 5px;
            position: relative;
            overflow: hidden;
        }

        .nav-link:hover {
            color: white !important;
            background-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        /* Footer Styling */
        .footer {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 3rem 0 1rem;
            margin-top: 2rem;
        }

        .footer-logo {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .footer a {
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .footer a:hover {
            color: white;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .footer-links h5 {
            color: white;
            font-weight: 600;
            margin-bottom: 1.2rem;
        }

        .footer-links ul {
            list-style: none;
            padding: 0;
        }

        .footer-links li {
            margin-bottom: 0.8rem;
        }

        .social-links a {
            font-size: 1.2rem;
            margin-right: 1rem;
        }

        .footer-bottom {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 2rem;
            padding-top: 1rem;
            text-align: center;
        }

        :root {
            --primary-color: #1a237e;
            --secondary-color: #283593;
            --accent-color: #2196F3;
            --success-color: #43a047;
            --error-color: #e53935;
        }

        /* Driver Controls Panel */
        .driver-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 200px;
        }

        .driver-controls h6 {
            margin-bottom: 12px;
            color: #1a237e;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .driver-controls button {
            width: 100%;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .driver-controls button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        /* Manual Stop Marker Styling */
        .bus-marker.manual-stop .bus-icon {
            background-color: #ffc107 !important;
            border: 3px solid #ff9800;
            box-shadow: 0 0 20px rgba(255, 193, 7, 0.6);
            animation: pulse-yellow 1.5s infinite;
        }

        @keyframes pulse-yellow {

            0%,
            100% {
                box-shadow: 0 0 20px rgba(255, 193, 7, 0.6);
            }

            50% {
                box-shadow: 0 0 30px rgba(255, 193, 7, 0.9);
            }
        }

        /* Accident Marker Styling */
        .bus-marker.accident .bus-icon {
            background-color: #f44336 !important;
            border: 3px solid #d32f2f;
            box-shadow: 0 0 25px rgba(244, 67, 54, 0.8);
            animation: flash-red 0.8s infinite;
        }

        @keyframes flash-red {

            0%,
            100% {
                background-color: #f44336;
                box-shadow: 0 0 25px rgba(244, 67, 54, 0.8);
            }

            50% {
                background-color: #ff1744;
                box-shadow: 0 0 35px rgba(255, 23, 68, 1);
                transform: scale(1.1);
            }
        }

        /* Add these navbar brand and bus icon styles */
        .navbar-brand .bus-icon {
            font-size: 2rem;
            margin-right: 10px;
            vertical-align: middle;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {

            0%,
            20%,
            50%,
            80%,
            100% {
                transform: translateY(0);
            }

            40% {
                transform: translateY(-10px);
            }

            60% {
                transform: translateY(-5px);
            }
        }

        /* Emergency Accident Button Styling */
        .btn-danger {
            background: linear-gradient(45deg, #f44336, #d32f2f) !important;
            border: none !important;
            color: white !important;
            font-weight: 600 !important;
            transition: all 0.3s ease !important;
            box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3) !important;
        }

        .btn-danger:hover {
            background: linear-gradient(45deg, #d32f2f, #b71c1c) !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.5) !important;
            animation: pulse-red 0.5s ease !important;
        }

        .btn-danger:active {
            transform: translateY(0) !important;
        }

        @keyframes pulse-red {
            0%, 100% { 
                box-shadow: 0 4px 12px rgba(244, 67, 54, 0.5); 
            }
            50% { 
                box-shadow: 0 6px 20px rgba(244, 67, 54, 0.8); 
                transform: translateY(-3px) scale(1.02);
            }
        }

        /* Make button groups responsive */
        .btn-group.flex-wrap {
            flex-wrap: wrap !important;
            gap: 5px;
        }

        .btn-group.flex-wrap .btn {
            margin-bottom: 5px;
        }

        /* Emergency notification styling */
        .custom-notification.emergency {
            background: linear-gradient(45deg, #d32f2f, #b71c1c);
            border-left: 5px solid #8b0000;
            box-shadow: 0 4px 12px rgba(211, 47, 47, 0.4);
            animation: emergencyPulse 1s ease-in-out infinite alternate;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
    </style>
</head>

<body>
    {% csrf_token %}
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="{% url 'home' %}">
                <span class="bus-icon">üöå</span>AMTS
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-center">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'home' %}">
                            <span class="me-1">üè†</span>Home
                        </a>
                    </li>
                    {% if user.is_authenticated %}
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'search' %}">
                            <span class="me-1">üîç</span>Search Bus
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'my_bookings' %}">
                            <span class="me-1">üé´</span>My Bookings
                        </a>
                    </li>
                    <li class="nav-item">
                        <span class="nav-link glass-effect">
                            <span class="me-1">üë§</span>{{ user.username }}
                        </span>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'logout' %}">
                            <span class="me-1">üö™</span>Logout
                        </a>
                    </li>
                    {% else %}
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'login' %}">
                            <span class="me-1">üîë</span>Login
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'register' %}">
                            <span class="me-1">‚ú®</span>Register
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero" id="home">
        <div id="map"></div>
        <div class="container hero-content">
            <h1 class="display-4">Welcome to AMTS</h1>
            <p class="lead">
                Your reliable partner for city transportation in Ahmedabad
            </p>
            <div class="search-box">
                <div class="row g-2">
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="fromLocation" placeholder="From" />
                    </div>
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="toLocation" placeholder="To" />
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary w-100" onclick="searchBuses()">
                            Search
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <button class="hero-arrow" id="heroArrow" onclick="toggleHeroContent()">
            ‚ñ≤
        </button>
    </section>

    <!-- Booking Section -->
    <section id="booking" class="py-5 d-none">
        <div class="container">
            <h2 class="text-center mb-4">Available Buses</h2>
            <div id="busResults">
                <!-- Bus results will be populated by JavaScript -->
            </div>
            <p id="noBusMessage" class="text-center text-danger mt-3 d-none">
                No buses available for the selected route.
            </p>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-4 mb-4">
                    <div class="footer-logo">üöå AMTS</div>
                    <p>Your trusted partner for public transportation in Ahmedabad. Making your daily commute easier,
                        safer, and more reliable.</p>
                    <div class="social-links mt-3">
                        <a href="#" title="Facebook"><i class="fab fa-facebook"></i></a>
                        <a href="#" title="Twitter"><i class="fab fa-twitter"></i></a>
                        <a href="#" title="Instagram"><i class="fab fa-instagram"></i></a>
                        <a href="#" title="LinkedIn"><i class="fab fa-linkedin"></i></a>
                    </div>
                </div>
                <div class="col-md-2 mb-4">
                    <div class="footer-links">
                        <h5>Quick Links</h5>
                        <ul>
                            <li><a href="{% url 'home' %}">Home</a></li>
                            <li><a href="{% url 'search' %}">Search Bus</a></li>
                            <li><a href="{% url 'my_bookings' %}">My Bookings</a></li>
                            <li><a href="#">About Us</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-md-3 mb-4">
                    <div class="footer-links">
                        <h5>Services</h5>
                        <ul>
                            <li><a href="#">Bus Routes</a></li>
                            <li><a href="#">Live Tracking</a></li>
                            <li><a href="{% url 'monthly_pass' %}">Monthly Pass</a></li>
                            <li><a href="{% url 'student_pass' %}">Student Pass</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-md-3 mb-4">
                    <div class="footer-links">
                        <h5>Contact Us</h5>
                        <ul>
                            <li><i class="fas fa-map-marker-alt me-2"></i> AMTS Headquarters</li>
                            <li><i class="fas fa-location-dot me-2"></i> Ahmedabad, Gujarat</li>
                            <li><i class="fas fa-phone me-2"></i> 1800-123-4567</li>
                            <li><i class="fas fa-envelope me-2"></i> support@amts.com</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p class="mb-0">&copy; {% now "Y" %} AMTS. All rights reserved. | <a href="#" class="text-white">Privacy
                        Policy</a> | <a href="#" class="text-white">Terms of Service</a></p>
            </div>
        </div>
    </footer>

    <div class="modal fade" id="liveTrackingModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Live Bus Tracking - Bus <span id="busNumberDisplay"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-0 h-100">
                        <div class="col-md-9 h-100">
                            <div id="trackingMap"></div>
                        </div>
                        <div class="col-md-3 h-100">
                            <div class="tracking-status">
                                <h6 class="text-primary">Live Bus Status</h6>
                                <div class="status-box">
                                    <strong>Current Location</strong>
                                    <div id="currentLocation"></div>
                                </div>
                                <div class="status-box">
                                    <strong>Next Stop</strong>
                                    <div id="nextStop"></div>
                                    <small id="nextStopTime" class="text-muted"></small>
                                </div>
                                <div class="status-box">
                                    <strong>Your Boarding Point</strong>
                                    <div id="boardingPoint"></div>
                                    <small id="boardingTime" class="text-muted"></small>
                                </div>
                                <div class="status-box">
                                    <strong>Your Destination</strong>
                                    <div id="destinationPoint"></div>
                                    <small id="arrivalTime" class="text-muted"></small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add this modal for bus selection -->
    <div class="modal fade" id="busSelectionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Select Bus to Track</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="bus-list">
                        <!-- Bus options will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add this before the closing body tag -->
    <div class="modal fade" id="ticketBookingModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Book Tickets</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="ticketBookingForm">
                        <div class="mb-3">
                            <label class="form-label">Bus Number</label>
                            <input type="text" class="form-control" id="bookingBusNumber" readonly>
                        </div>
                        <div class="row mb-3">
                            <div class="col">
                                <label class="form-label">From</label>
                                <input type="text" class="form-control" id="bookingFromStop" readonly>
                            </div>
                            <div class="col">
                                <label class="form-label">To</label>
                                <input type="text" class="form-control" id="bookingToStop" readonly>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Number of Passengers</label>
                            <input type="number" class="form-control" id="passengerCount" min="1" max="6" value="1">
                        </div>
                        <div id="passengerDetails"></div>
                        <div class="mb-3">
                            <label class="form-label">Total Amount</label>
                            <input type="text" class="form-control" id="totalAmount" readonly>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="proceedToPayment()">Proceed to
                        Payment</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal fade" id="paymentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Payment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="paymentGateway"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ticket Modal -->
    <div class="modal fade" id="ticketModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Your Tickets</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="ticketContainer"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="downloadTickets()">Download Tickets</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Add at the start of your script
        window.notificationShown = false;

        // Sample route data
        const routes = [
            {
                route: "1A",
                from: "Lal Darwaja",
                to: "Bopal",
                frequency: "10 mins",
                firstBus: "06:00",
                lastBus: "22:00",
            },
            {
                route: "2B",
                from: "Kalupur",
                to: "Satellite",
                frequency: "15 mins",
                firstBus: "06:30",
                lastBus: "21:30",
            },
            {
                route: "3C",
                from: "Naroda",
                to: "Vasna",
                frequency: "20 mins",
                firstBus: "07:00",
                lastBus: "21:00",
            },
        ];

        // Populate routes table
        function populateRoutes() {
            const routesTable = document.getElementById("routesTable");
            routesTable.innerHTML = routes
                .map(
                    (route) => `
                <tr>
                    <td>${route.route}</td>
                    <td>${route.from}</td>
                    <td>${route.to}</td>
                    <td>${route.frequency}</td>
                    <td>${route.firstBus}</td>
                    <td>${route.lastBus}</td>
                </tr>
            `
                )
                .join("");
        }

        // Search buses function
        function toggleHeroContent() {
            const heroContent = document.querySelector(".hero-content");
            const heroArrow = document.getElementById("heroArrow");


            heroContent.classList.toggle("d-none");
            heroArrow.innerHTML = "‚ñ≤";

        }



        // Global variables
        let map;
        let currentRoute = null;
        let trackingMap = null;
        let busMarker = null;
        let routeLine = null;
        let trackingInterval = null;

        // Add at the start of your script
        let allStops = new Set();

        // Function to load all unique stops
        async function loadAllStops() {
            try {
                const response = await fetch('/api/search/', {
                    method: 'POST',
                    body: new FormData(Object.assign(document.createElement('form'), {
                        innerHTML: `
                    <input name="from" value="get_stops">
                    <input name="to" value="all">
                `
                    }))
                });
                const data = await response.json();
                if (data.stops) {
                    allStops = new Set(data.stops);
                }
            } catch (error) {
                console.error('Error loading stops:', error);
            }
        }

        // Call this when page loads
        loadAllStops();

        // Function to show suggestions
        function showSuggestions(input, suggestionsContainer) {
            const value = input.value.toLowerCase().trim();
            input.parentElement.classList.toggle('has-suggestions', value.length > 0);

            if (!value) {
                suggestionsContainer.style.display = 'none';
                return;
            }

            const matches = Array.from(allStops).filter(stop =>
                stop.toLowerCase().includes(value)
            ).sort((a, b) => {
                // Prioritize matches that start with the input value
                const aStartsWith = a.toLowerCase().startsWith(value);
                const bStartsWith = b.toLowerCase().startsWith(value);
                if (aStartsWith && !bStartsWith) return -1;
                if (!aStartsWith && bStartsWith) return 1;
                return a.localeCompare(b);
            });

            if (matches.length > 0) {
                suggestionsContainer.innerHTML = matches
                    .map(stop => `<div class="suggestion-item">${stop}</div>`)
                    .join('');
            } else {
                suggestionsContainer.innerHTML = `
            <div class="no-suggestions">
                No stops found matching "${input.value}"
            </div>
        `;
            }

            suggestionsContainer.style.display = 'block';

            // Add click handlers to suggestions
            suggestionsContainer.querySelectorAll('.suggestion-item').forEach(item => {
                item.addEventListener('click', () => {
                    input.value = item.textContent;
                    input.parentElement.classList.remove('has-suggestions');
                    suggestionsContainer.style.display = 'none';
                });
            });
        }

        // Initialize suggestions for both inputs
        document.addEventListener('DOMContentLoaded', () => {
            const fromInput = document.getElementById('fromLocation');
            const toInput = document.getElementById('toLocation');

            // Wrap inputs in container for proper positioning
            ['fromLocation', 'toLocation'].forEach(id => {
                const input = document.getElementById(id);
                const wrapper = document.createElement('div');
                wrapper.className = 'search-input';
                input.parentNode.insertBefore(wrapper, input);
                wrapper.appendChild(input);
            });

            // Create suggestion containers
            const fromSuggestions = document.createElement('div');
            fromSuggestions.className = 'suggestions-container';
            const toSuggestions = document.createElement('div');
            toSuggestions.className = 'suggestions-container';

            // Insert containers after inputs
            fromInput.parentNode.appendChild(fromSuggestions);
            toInput.parentNode.appendChild(toSuggestions);

            // Add input event listeners with debounce
            let debounceTimeout;
            const debounce = (fn, delay) => {
                return function (...args) {
                    clearTimeout(debounceTimeout);
                    debounceTimeout = setTimeout(() => fn.apply(this, args), delay);
                };
            };

            fromInput.addEventListener('input', debounce(() => showSuggestions(fromInput, fromSuggestions), 200));
            toInput.addEventListener('input', debounce(() => showSuggestions(toInput, toSuggestions), 200));

            // Add keyboard navigation
            [fromInput, toInput].forEach(input => {
                input.addEventListener('keydown', (e) => {
                    const container = input === fromInput ? fromSuggestions : toSuggestions;
                    const items = container.querySelectorAll('.suggestion-item');
                    const highlighted = container.querySelector('.highlighted');

                    switch (e.key) {
                        case 'ArrowDown':
                        case 'ArrowUp':
                            e.preventDefault();
                            if (!highlighted) {
                                items[e.key === 'ArrowDown' ? 0 : items.length - 1].classList.add('highlighted');
                            } else {
                                const currentIndex = Array.from(items).indexOf(highlighted);
                                highlighted.classList.remove('highlighted');
                                const nextIndex = e.key === 'ArrowDown'
                                    ? (currentIndex + 1) % items.length
                                    : (currentIndex - 1 + items.length) % items.length;
                                items[nextIndex].classList.add('highlighted');
                                items[nextIndex].scrollIntoView({ block: 'nearest' });
                            }
                            break;
                        case 'Enter':
                            if (highlighted) {
                                input.value = highlighted.textContent;
                                container.style.display = 'none';
                                input.parentElement.classList.remove('has-suggestions');
                            }
                            break;
                        case 'Escape':
                            container.style.display = 'none';
                            input.parentElement.classList.remove('has-suggestions');
                            break;
                    }
                });
            });

            // Hide suggestions when clicking outside
            document.addEventListener('click', (e) => {
                if (!fromInput.contains(e.target) && !fromSuggestions.contains(e.target)) {
                    fromSuggestions.style.display = 'none';
                    fromInput.parentElement.classList.remove('has-suggestions');
                }
                if (!toInput.contains(e.target) && !toSuggestions.contains(e.target)) {
                    toSuggestions.style.display = 'none';
                    toInput.parentElement.classList.remove('has-suggestions');
                }
            });
        });

        // Update the search function to be case insensitive
        async function searchBuses() {
            const fromLocation = document.getElementById('fromLocation').value;
            const toLocation = document.getElementById('toLocation').value;

            // Case insensitive matching with available stops
            const matchedFrom = Array.from(allStops).find(stop =>
                stop.toLowerCase() === fromLocation.toLowerCase()
            );
            const matchedTo = Array.from(allStops).find(stop =>
                stop.toLowerCase() === toLocation.toLowerCase()
            );

            if (!matchedFrom || !matchedTo) {
                alert('Please select valid stops from the suggestions');
                return;
            }

            // Use matched (correct case) values for the search
            // ... rest of your existing search code ...
        }

        // Initialize map when the page loads
        document.addEventListener("DOMContentLoaded", function () {
            // Initialize the map
            map = L.map("map", {
                scrollWheelZoom: false,  // Disable scroll wheel zoom completely
                zoomControl: true,       // Keep the zoom control buttons
                doubleClickZoom: false   // Disable double-click zoom
            }).setView([23.0225, 72.5714], 13); // Ahmedabad coordinates

            // Add the OpenStreetMap tiles
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                maxZoom: 18,
                minZoom: 5
            }).addTo(map);

            // Custom zoom control with Ctrl key
            let isCtrlPressed = false;

            document.addEventListener('keydown', function (e) {
                if (e.key === 'Control') {
                    isCtrlPressed = true;
                    map.scrollWheelZoom.enable();
                }
            });

            document.addEventListener('keyup', function (e) {
                if (e.key === 'Control') {
                    isCtrlPressed = false;
                    map.scrollWheelZoom.disable();
                }
            });

            // Disable zoom when leaving the window
            window.addEventListener('blur', function () {
                isCtrlPressed = false;
                map.scrollWheelZoom.disable();
            });

            // Handle Ctrl + +/- for zoom
            document.addEventListener('keydown', function (e) {
                if (e.ctrlKey) {
                    if (e.key === '+' || e.key === '=') {
                        e.preventDefault();
                        map.zoomIn();
                    } else if (e.key === '-') {
                        e.preventDefault();
                        map.zoomOut();
                    }
                }
            });
        });

        // Search function
        function searchBuses() {
            const from = document.getElementById("fromLocation").value.trim();
            const to = document.getElementById("toLocation").value.trim();

            if (!from || !to) {
                alert("Please fill in both 'From' and 'To' fields");
                return;
            }

            // Create form data
            const formData = new FormData();
            formData.append('from', from);
            formData.append('to', to);

            // Make API call
            fetch('/api/search/', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        displayRoutes(data.routes, from, to);
                    } else {
                        alert('No routes found');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById("busResults").innerHTML =
                        '<div class="alert alert-danger">Error searching for buses. Please try again.</div>';
                });
        }

        // Display routes function
        function displayRoutes(routes, from, to) {
            document.querySelector('.hero-content').classList.add('d-none');
            const busResults = document.getElementById("busResults");
            const bookingSection = document.getElementById("booking");

            if (!routes || routes.length === 0) {
                busResults.innerHTML = '<div class="alert alert-warning">No routes found</div>';
                return;
            }

            // Separate direct and transfer routes
            const directRoutes = routes.filter(route => route.transfers === 0);
            const transferRoutes = routes.filter(route => route.transfers > 0);

            bookingSection.classList.remove("d-none");

            let resultsHtml = `
        <div class="container">
            <div class="mb-4">
                <h3>Routes from ${from} to ${to}</h3>
            </div>
    `;

            // If direct routes exist, only show them
            if (directRoutes.length > 0) {
                resultsHtml += `<div class="direct-routes">
            <h4 class="text-success mb-3">Direct Routes</h4>`;

                directRoutes.forEach((route, index) => {
                    const routeData = encodeURIComponent(JSON.stringify(route));

                    resultsHtml += `
                <div class="card mb-3 border-success">
                    <div class="card-body">
                        <h5 class="card-title">Direct Route - Bus ${route.route_parts[0].bus_number}</h5>
                        <div class="route-details">`;

                    route.route_parts.forEach(part => {
                        resultsHtml += `
                    <div class="route-part mb-2">
                        <strong>Bus ${part.bus_number}</strong>
                        <p class="mb-1">Stops (${part.total_stops}): 
                            ${part.stops.map(stop => stop.name).join(' ‚Üí ')}</p>
                    </div>`;
                    });

                    resultsHtml += `
                        </div>
                        <div class="mt-3 d-flex gap-2 flex-wrap">
                            <a href="#map" class="btn btn-primary" onclick="showRouteOnMap(${index}, '${routeData}')">
                                Show Route on Map
                            </a>
                            <button class="btn btn-success" onclick="showBusOptions('${route.route_parts[0].bus_number}', '${from}', '${to}')">
                                Live Track
                            </button>
                            <button class="btn btn-warning" onclick="bookTicket('${route.route_parts[0].bus_number}', '${from}', '${to}')">
                                Book Ticket
                            </button>
                        </div>
                    </div>
                </div>`;
                });

                resultsHtml += `</div>`;
            } else {
                // Only show transfer routes if no direct routes exist
                resultsHtml += `<div class="transfer-routes">
            <h4 class="text-primary mb-3">Available Routes with Transfers</h4>`;

                transferRoutes.forEach((route, index) => {
                    const routeData = encodeURIComponent(JSON.stringify(route));

                    resultsHtml += `
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Route with ${route.transfers} transfer(s)</h5>
                        <div class="route-details">`;

                    // For each part of the route (each bus)
                    route.route_parts.forEach((part, partIndex) => {
                        const isLastPart = partIndex === route.route_parts.length - 1;
                        const fromStop = part.stops[0].name;
                        const toStop = part.stops[part.stops.length - 1].name;

                        resultsHtml += `
                    <div class="route-part mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <strong>Bus ${part.bus_number}</strong>
                            <div class="btn-group flex-wrap">
                                <button class="btn btn-sm btn-success" onclick="showBusOptions('${part.bus_number}', '${fromStop}', '${toStop}')">
                                    Live Track Bus ${part.bus_number}
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="bookTicket('${part.bus_number}', '${fromStop}', '${toStop}')">
                                    Book Ticket for Bus ${part.bus_number}
                                </button>
                            </div>
                        </div>
                        <p class="mb-1">From: ${fromStop} ‚Üí To: ${toStop}</p>
                        <p class="mb-1">Stops (${part.total_stops}): 
                            ${part.stops.map(stop => stop.name).join(' ‚Üí ')}</p>
                        ${!isLastPart ?
                                `<div class="transfer-point">
                                Transfer at ${toStop} to Bus ${route.route_parts[partIndex + 1].bus_number}
                            </div>` : ''}
                    </div>`;
                    });

                    resultsHtml += `
                        </div>
                        <div class="mt-3">
                            <a href="#map" class="btn btn-primary" onclick="showRouteOnMap(${index}, '${routeData}')">
                                Show Complete Route on Map
                            </a>
                        </div>
                    </div>
                </div>`;
                });

                resultsHtml += `</div>`;
            }

            resultsHtml += `</div>`;
            busResults.innerHTML = resultsHtml;
            location.href = "#booking";
        }

        // Function to get road-based route between two points
        async function getRoadBasedRoute(start, end) {
            try {
                // Using OSRM API with driving profile
                const response = await fetch(
                    `https://router.project-osrm.org/route/v1/driving/` +
                    `${start[1]},${start[0]};${end[1]},${end[0]}?` +
                    `steps=true&geometries=geojson&overview=full`
                );

                const data = await response.json();

                if (data.code === 'Ok' && data.routes && data.routes[0]) {
                    // Extract the detailed road geometry
                    return data.routes[0].geometry.coordinates.map(coord => [coord[1], coord[0]]);
                }

                // If OSRM fails, try Mapbox API
                const mapboxResponse = await fetch(
                    `https://api.mapbox.com/directions/v5/mapbox/driving/` +
                    `${start[1]},${start[0]};${end[1]},${end[0]}?` +
                    `steps=true&geometries=geojson&access_token=pk.YOUR_MAPBOX_TOKEN`
                );

                const mapboxData = await mapboxResponse.json();

                if (mapboxData.routes && mapboxData.routes[0]) {
                    return mapboxData.routes[0].geometry.coordinates.map(coord => [coord[1], coord[0]]);
                }

                throw new Error('No routing service available');
            } catch (error) {
                console.error('Error getting road route:', error);

                // Fallback to direct line with waypoints
                const waypoints = await getWaypoints(start, end);
                return waypoints;
            }
        }

        // Helper function to get intermediate waypoints along roads
        async function getWaypoints(start, end) {
            try {
                // Get road intersections between points using Overpass API
                const bbox = getBoundingBox(start, end);
                const query = `
            [out:json][timeout:25];
            way["highway"](${bbox.south},${bbox.west},${bbox.north},${bbox.east});
            (._;>;);
            out body;
        `;

                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: query
                });

                const data = await response.json();

                if (data.elements) {
                    // Extract road nodes
                    const nodes = data.elements.filter(e => e.type === 'node');

                    // Get points along the road
                    const points = getRoutePoints(start, end, nodes);
                    return points;
                }
            } catch (error) {
                console.error('Error getting waypoints:', error);
            }

            // Final fallback to simple curved line
            return createCurvedLine(start, end);
        }

        // Helper function to get bounding box
        function getBoundingBox(start, end) {
            const padding = 0.01; // About 1km padding
            return {
                south: Math.min(start[0], end[0]) - padding,
                north: Math.max(start[0], end[0]) + padding,
                west: Math.min(start[1], end[1]) - padding,
                east: Math.max(start[1], end[1]) + padding
            };
        }

        // Helper function to get route points
        function getRoutePoints(start, end, nodes) {
            // Sort nodes by distance from the direct line
            const points = [start];

            // Add intermediate points
            nodes.forEach(node => {
                if (isPointNearLine(node.lat, node.lon, start, end)) {
                    points.push([node.lat, node.lon]);
                }
            });

            points.push(end);
            return points;
        }

        // Helper function to check if point is near line
        function isPointNearLine(lat, lon, start, end) {
            const threshold = 0.001; // About 100m threshold
            const d = pointToLineDistance(lat, lon, start, end);
            return d < threshold;
        }

        // Helper function to calculate point to line distance
        function pointToLineDistance(lat, lon, start, end) {
            const x = lat;
            const y = lon;
            const x1 = start[0];
            const y1 = start[1];
            const x2 = end[0];
            const y2 = end[1];

            const A = x - x1;
            const B = y - y1;
            const C = x2 - x1;
            const D = y2 - y1;

            const dot = A * C + B * D;
            const len_sq = C * C + D * D;

            let param = -1;
            if (len_sq != 0) param = dot / len_sq;

            let xx, yy;

            if (param < 0) {
                xx = x1;
                yy = y1;
            } else if (param > 1) {
                xx = x2;
                yy = y2;
            } else {
                xx = x1 + param * C;
                yy = y1 + param * D;
            }

            const dx = x - xx;
            const dy = y - yy;
            return Math.sqrt(dx * dx + dy * dy);
        }

        // Update the route drawing part in showRouteOnMap function
        async function showRouteOnMap(routeIndex, encodedRoute) {
            try {
                const route = JSON.parse(decodeURIComponent(encodedRoute));

                if (currentRoute) {
                    map.removeLayer(currentRoute);
                }

                currentRoute = L.featureGroup().addTo(map);

                for (const part of route.route_parts) {
                    if (part.stops && part.stops.length > 0) {
                        // Draw route between consecutive stops
                        for (let i = 0; i < part.stops.length - 1; i++) {
                            const start = part.stops[i].coordinates;
                            const end = part.stops[i + 1].coordinates;

                            try {
                                // Get road-based route between stops
                                const roadRoute = await getRoadBasedRoute(start, end);

                                // Draw the route with thicker line and smoother appearance
                                const polyline = L.polyline(roadRoute, {
                                    color: '#2196F3',
                                    weight: 5,
                                    opacity: 0.8,
                                    lineCap: 'round',
                                    lineJoin: 'round',
                                    smoothFactor: 1
                                }).addTo(currentRoute);

                                // Add arrow decorators more frequently
                                L.polylineDecorator(polyline, {
                                    patterns: [{
                                        offset: 25,
                                        repeat: 100,  // Increased repeat distance
                                        symbol: L.Symbol.arrowHead({
                                            pixelSize: 12,
                                            polygon: false,
                                            pathOptions: {
                                                stroke: true,
                                                color: '#2196F3',
                                                weight: 3
                                            }
                                        })
                                    }]
                                }).addTo(currentRoute);
                            } catch (error) {
                                console.error('Error drawing route segment:', error);
                            }
                        }

                        // Add markers for stops
                        part.stops.forEach((stop, index) => {
                            if (index === 0 && part === route.route_parts[0]) {
                                // Start marker (blue)
                                L.marker(stop.coordinates, {
                                    icon: L.icon({
                                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                                        iconSize: [25, 41],
                                        iconAnchor: [12, 41],
                                        popupAnchor: [1, -34],
                                        shadowSize: [41, 41]
                                    })
                                })
                                    .bindPopup(`<div class="stop-popup">
                            <strong>${stop.name}</strong>
                            <br>Starting Point
                            <br>Bus ${part.bus_number}
                        </div>`)
                                    .addTo(currentRoute);
                            } else if (index === part.stops.length - 1 && part === route.route_parts[route.route_parts.length - 1]) {
                                // End marker (red)
                                L.marker(stop.coordinates, {
                                    icon: L.icon({
                                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                                        iconSize: [25, 41],
                                        iconAnchor: [12, 41],
                                        popupAnchor: [1, -34],
                                        shadowSize: [41, 41]
                                    })
                                })
                                    .bindPopup(`<div class="stop-popup">
                            <strong>${stop.name}</strong>
                            <br><span style="color: #f44336;">Destination</span>
                            <br>Bus ${part.bus_number}
                        </div>`)
                                    .addTo(currentRoute);
                            } else {
                                // Intermediate stops
                                L.circleMarker(stop.coordinates, {
                                    radius: 5,
                                    fillColor: '#4CAF50',
                                    color: '#fff',
                                    weight: 2,
                                    opacity: 1,
                                    fillOpacity: 1
                                })
                                    .bindPopup(`<div class="stop-popup">
                            <strong>${stop.name}</strong>
                            <br>Bus ${part.bus_number}
                        </div>`)
                                    .addTo(currentRoute);
                            }
                        });
                    }
                }

                // Fit the map to show all markers and routes
                if (currentRoute.getLayers().length > 0) {
                    map.fitBounds(currentRoute.getBounds(), {
                        padding: [50, 50],
                        maxZoom: 15
                    });
                }
            } catch (error) {
                console.error("Error showing route on map:", error);
            }
        }

        // Helper function to create curved line
        function createCurvedLine(start, end) {
            const pointsCount = 50;
            const points = [];

            for (let i = 0; i <= pointsCount; i++) {
                const fraction = i / pointsCount;
                const offset = 0.0002 * Math.sin(fraction * Math.PI);

                const lat = start[0] + (end[0] - start[0]) * fraction;
                const lng = start[1] + (end[1] - start[1]) * fraction + offset;

                points.push([lat, lng]);
            }

            return points;
        }

        // Add this function for booking tickets
        function bookTicket(busNumber, fromStop, toStop) {
            // Reset any existing error messages
            const errorElements = document.querySelectorAll('.alert-danger');
            errorElements.forEach(el => el.remove());

            // Set values in booking modal
            document.getElementById('bookingBusNumber').value = busNumber;
            document.getElementById('bookingFromStop').value = fromStop;
            document.getElementById('bookingToStop').value = toStop;

            // Reset passenger count and update details
            const passengerCount = document.getElementById('passengerCount');
            passengerCount.value = 1;

            // Show booking modal first
            const bookingModal = new bootstrap.Modal(document.getElementById('ticketBookingModal'));
            bookingModal.show();

            // Then update passenger details
            updatePassengerDetails(1).catch(error => {
                console.error('Error updating passenger details:', error);
            });
        }

        // Update the updatePassengerDetails function
        async function updatePassengerDetails(count) {
            const container = document.getElementById('passengerDetails');
            container.innerHTML = ''; // Clear any existing content

            // Get booking details
            const fromStop = document.getElementById('bookingFromStop').value;
            const toStop = document.getElementById('bookingToStop').value;
            const busNumber = document.getElementById('bookingBusNumber').value;

            // Trigger fare calculation
            await calculateFare(fromStop, toStop, busNumber, count);
        }

        // Update the event listener for passenger count changes
        document.addEventListener('DOMContentLoaded', function () {
            const passengerCount = document.getElementById('passengerCount');
            if (passengerCount) {
                passengerCount.addEventListener('change', function () {
                    const count = parseInt(this.value);
                    if (count > 0 && count <= 6) { // Add validation for reasonable limits
                        updatePassengerDetails(count);
                    } else {
                        this.value = 1; // Reset to 1 if invalid
                        updatePassengerDetails(1);
                    }
                });
            }
        });

        // Add a debounced input handler for passenger details
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Update the debounced input handler to be more specific
        // Replace the existing debounced input handler with this one:
        document.addEventListener('input', debounce(async (e) => {
            if (e.target.matches('#passengerDetails input')) {
                // Don't rebuild the form, just update the fare
                const fromStop = document.getElementById('bookingFromStop').value;
                const toStop = document.getElementById('bookingToStop').value;
                const busNumber = document.getElementById('bookingBusNumber').value;
                const count = parseInt(document.getElementById('passengerCount').value);

                // Only calculate fare, don't update passenger details
                await calculateFare(fromStop, toStop, busNumber, count);
            }
        }, 1000)); // Increased debounce time to 1 second

        // Update the calculateFare function to properly handle all routes
        async function calculateFare(fromStop, toStop, busNumber, count) {
            try {
                const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
                const formData = new FormData();
                formData.append('from', fromStop);
                formData.append('to', toStop);
                formData.append('bus_number', busNumber);

                const response = await fetch('/api/search/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken
                    },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                console.log('API Response:', data);

                if (data.status === 'success' && data.routes && data.routes.length > 0) {
                    // First try to find a direct route
                    for (const route of data.routes) {
                        if (route.transfers === 0) {
                            const busRoute = route.route_parts[0];
                            if (busRoute.bus_number === busNumber) {
                                const stops = busRoute.stops;
                                const fromIndex = stops.findIndex(stop => stop.name === fromStop);
                                const toIndex = stops.findIndex(stop => stop.name === toStop);

                                if (fromIndex !== -1 && toIndex !== -1) {
                                    // Calculate fare for direct route
                                    const totalStops = Math.abs(toIndex - fromIndex);
                                    calculateAndDisplayFare(totalStops, count);
                                    return;
                                }
                            }
                        }
                    }

                    // If no direct route, check routes with transfers
                    for (const route of data.routes) {
                        if (route.transfers > 0) {
                            // Find the part of the route that uses our bus number
                            const busRoutePart = route.route_parts.find(part => part.bus_number === busNumber);
                            if (busRoutePart) {
                                const stops = busRoutePart.stops;
                                let fromIndex = -1;
                                let toIndex = -1;

                                // Check if our stops are in this part of the route
                                fromIndex = stops.findIndex(stop => stop.name === fromStop);
                                toIndex = stops.findIndex(stop => stop.name === toStop);

                                if (fromIndex !== -1 && toIndex !== -1) {
                                    // Calculate fare for this part of the route
                                    const totalStops = Math.abs(toIndex - fromIndex);
                                    calculateAndDisplayFare(totalStops, count);
                                    return;
                                }
                            }
                        }
                    }
                }

                throw new Error('Could not find valid route data');

            } catch (error) {
                console.error('Error calculating fare:', error);
                displayFareError();
            }
        }

        // Helper function to calculate and display fare
        function calculateAndDisplayFare(totalStops, count) {
            const baseFare = 10; // Base fare in rupees
            const farePerStop = 2; // Additional fare per stop
            const maxFarePerPerson = 50; // Maximum fare cap per person

            // Calculate fare per person with cap
            const farePerPerson = Math.min(baseFare + (farePerStop * totalStops), maxFarePerPerson);
            const totalFare = farePerPerson * count;

            // Update total amount
            document.getElementById('totalAmount').value = `‚Çπ${totalFare}`;

            // Show fare breakdown
            const fareBreakdown = document.createElement('div');
            fareBreakdown.className = 'fare-breakdown mt-3';
            fareBreakdown.innerHTML = `
        <h6>Fare Breakdown:</h6>
        <ul class="list-unstyled">
            <li>Base Fare: ‚Çπ${baseFare}</li>
            <li>Number of Stops: ${totalStops}</li>
            <li>Fare per Stop: ‚Çπ${farePerStop}</li>
            <li>Number of Passengers: ${count}</li>
            <li>Fare per Person: ‚Çπ${farePerPerson} (Max: ‚Çπ${maxFarePerPerson})</li>
            <li class="fw-bold border-top pt-2">Total Fare: ‚Çπ${totalFare}</li>
        </ul>
    `;

            // Update or add fare breakdown
            const container = document.getElementById('passengerDetails');
            const existingBreakdown = container.querySelector('.fare-breakdown');
            if (existingBreakdown) {
                existingBreakdown.replaceWith(fareBreakdown);
            } else {
                container.appendChild(fareBreakdown);
            }

            // Remove any existing error messages
            const errorMessage = container.querySelector('.alert-danger');
            if (errorMessage) {
                errorMessage.remove();
            }
        }

        // Helper function to display fare error
        function displayFareError() {
            // Show error message
            document.getElementById('totalAmount').value = '';

            // Display user-friendly error
            const errorMessage = document.createElement('div');
            errorMessage.className = 'alert alert-danger mt-3';
            errorMessage.textContent = 'Unable to calculate fare at this time. Please try again later.';

            // Update or add error message
            const container = document.getElementById('passengerDetails');
            const existingError = container.querySelector('.alert-danger');
            if (existingError) {
                existingError.replaceWith(errorMessage);
            } else {
                container.appendChild(errorMessage);
            }
        }

        // Update the proceedToPayment function to handle fare calculation errors
        function proceedToPayment() {
            // Validate passenger count
            const passengerCount = parseInt(document.getElementById('passengerCount').value);
            const isValid = validatePassengerDetails(passengerCount);

            if (!isValid) {
                return;
            }

            const totalAmount = document.getElementById('totalAmount').value;

            if (!totalAmount) {
                alert('Unable to proceed. Please wait for fare calculation to complete.');
                return;
            }

            // If validation passes, proceed with payment
            bootstrap.Modal.getInstance(document.getElementById('ticketBookingModal')).hide();

            // Show payment modal
            const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
            document.getElementById('paymentGateway').innerHTML = `
        <form id="paymentForm" class="p-3">
            <div class="mb-3">
                <label class="form-label">Card Number</label>
                <input type="text" class="form-control" id="cardNumber" placeholder="1234 5678 9012 3456" required>
            </div>
            <div class="row mb-3">
                <div class="col">
                    <label class="form-label">Expiry Date</label>
                    <input type="text" class="form-control" id="cardExpiry" placeholder="MM/YY" required>
                </div>
                <div class="col">
                    <label class="form-label">CVV</label>
                    <input type="text" class="form-control" id="cardCvv" placeholder="123" required>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Card Holder Name</label>
                <input type="text" class="form-control" id="cardName" placeholder="John Doe" required>
            </div>
            <div class="d-grid">
                <button type="button" class="btn btn-primary" onclick="processPayment()">Pay ${totalAmount}</button>
            </div>
        </form>
    `;
            paymentModal.show();
        }

        // Add new validation function
        function validatePassengerDetails(passengerCount) {
            // Only validate that passenger count is valid
            if (passengerCount < 1 || passengerCount > 6) {
                const countInput = document.getElementById('passengerCount');
                addErrorStyling(countInput, 'Please enter a valid number of passengers (1-6)');
                return false;
            }
            return true;
        }

        // Helper function to add error styling
        function addErrorStyling(element, message) {
            if (element) {
                element.classList.add('is-invalid');

                // Create or update error message
                let errorDiv = element.nextElementSibling;
                if (!errorDiv || !errorDiv.classList.contains('invalid-feedback')) {
                    errorDiv = document.createElement('div');
                    errorDiv.className = 'invalid-feedback';
                    element.parentNode.insertBefore(errorDiv, element.nextSibling);
                }
                errorDiv.textContent = message;
            }
        }

        // Helper function to remove error styling
        function removeErrorStyling(element) {
            if (element) {
                element.classList.remove('is-invalid');
                const errorDiv = element.nextElementSibling;
                if (errorDiv && errorDiv.classList.contains('invalid-feedback')) {
                    errorDiv.remove();
                }
            }
        }

        // Update the processPayment function
        async function processPayment() {
            try {
                const bookingForm = document.getElementById('ticketBookingForm');
                const formData = new FormData(bookingForm);

                // Add payment details
                formData.append('cardNumber', document.getElementById('cardNumber').value);
                formData.append('cardExpiry', document.getElementById('cardExpiry').value);
                formData.append('cardCvv', document.getElementById('cardCvv').value);
                formData.append('cardName', document.getElementById('cardName').value);
                formData.append('totalAmount', document.getElementById('totalAmount').value);

                // Add passenger count
                const passengerCount = document.getElementById('passengerCount').value;
                formData.append('passengerCount', passengerCount);

                // Add booking details
                formData.append('bookingBusNumber', document.getElementById('bookingBusNumber').value);
                formData.append('bookingFromStop', document.getElementById('bookingFromStop').value);
                formData.append('bookingToStop', document.getElementById('bookingToStop').value);

                const response = await fetch('/api/create-booking/', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.status === 'success') {
                    // Hide payment modal
                    bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();

                    // Show tickets
                    displayTickets(data.tickets);
                } else {
                    alert(data.message || 'Payment failed. Please try again.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error processing payment. Please try again.');
            }
        }

        // Add this code to format card number input
        document.addEventListener('DOMContentLoaded', function () {
            document.body.addEventListener('input', function (e) {
                if (e.target.id === 'cardNumber') {
                    e.target.value = formatCardNumber(e.target.value);
                } else if (e.target.id === 'cardExpiry') {
                    e.target.value = formatExpiry(e.target.value);
                } else if (e.target.id === 'cardCvv') {
                    e.target.value = e.target.value.replace(/\D/g, '').slice(0, 3);
                }
            });
        });

        function formatCardNumber(value) {
            const v = value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
            const matches = v.match(/\d{4,16}/g);
            const match = matches && matches[0] || '';
            const parts = [];

            for (let i = 0, len = match.length; i < len; i += 4) {
                parts.push(match.substring(i, i + 4));
            }

            if (parts.length) {
                return parts.join(' ');
            } else {
                return value;
            }
        }

        function formatExpiry(value) {
            const v = value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
            if (v.length >= 2) {
                return v.slice(0, 2) + '/' + v.slice(2, 4);
            }
            return v;
        }

        // Function to verify payment and generate tickets
        async function verifyPayment(paymentResponse, bookingId) {
            const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

            try {
                const response = await fetch('/api/verify-payment/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        payment_id: paymentResponse.razorpay_payment_id,
                        order_id: paymentResponse.razorpay_order_id,
                        signature: paymentResponse.razorpay_signature,
                        booking_id: bookingId
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    // Hide payment modal
                    bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();

                    // Show tickets
                    displayTickets(data.tickets);
                } else {
                    alert(data.message || 'Payment verification failed');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error verifying payment');
            }
        }

        // Function to display tickets
        function displayTickets(tickets) {
            const container = document.getElementById('ticketContainer');
            container.innerHTML = tickets.map(ticket => `
        <div class="ticket-card mb-3">
            <div class="qr-code">
                <img src="${ticket.qr_code}" alt="QR Code">
            </div>
            <div class="ticket-details">
                <p>Bus: ${ticket.bus_number}</p>
                <p>From: ${ticket.from_stop} To: ${ticket.to_stop}</p>
                <p>Date: ${ticket.date}</p>
                <p>Ticket ID: ${ticket.ticket_id}</p>
            </div>
        </div>
    `).join('');

            // Show ticket modal
            const ticketModal = new bootstrap.Modal(document.getElementById('ticketModal'));
            ticketModal.show();
        }

        // Function to download tickets
        function downloadTickets() {
            // Implementation for downloading tickets as PDF
            window.print();
        }

        // Show booking function
        function showBooking() {
            location.href = "#booking";
        }

        // Show tracking function
        function showTracking() {
            alert("Live tracking feature will be implemented here");
        }

        // Add the Polyline encoding/decoding utility
        L.Polyline.prototype.fromEncoded = function (encoded, options) {
            var coords = [];
            var index = 0, len = encoded.length;
            var lat = 0, lng = 0;

            while (index < len) {
                var b, shift = 0, result = 0;
                do {
                    b = encoded.charAt(index++).charCodeAt(0) - 63;
                    result |= (b & 0x1f) << shift;
                    shift += 5;
                } while (b >= 0x20);
                var dlat = ((result & 1) ? ~(result >> 1) : (result >> 1));
                lat += dlat;

                shift = 0;
                result = 0;
                do {
                    b = encoded.charAt(index++).charCodeAt(0) - 63;
                    result |= (b & 0x1f) << shift;
                    shift += 5;
                } while (b >= 0x20);
                var dlng = ((result & 1) ? ~(result >> 1) : (result >> 1));
                lng += dlng;

                coords.push([lat * 1e-5, lng * 1e-5]);
            }
            return coords;
        };

        async function showBusOptions(busNumber, fromLocation, toLocation) {
            try {
                // First get the bus route to determine direction
                const routeResponse = await fetch(`/api/search/`, {
                    method: 'POST',
                    body: new FormData(Object.assign(document.createElement('form'), {
                        innerHTML: `
                    <input name="from" value="${busNumber}">
                    <input name="to" value="track">
                `
                    }))
                });
                const routeData = await routeResponse.json();

                if (!routeData.status === 'success' || !routeData.routes.length) {
                    alert('Bus route not found');
                    return;
                }

                const stops = routeData.routes[0].route_parts[0].stops;
                const fromIndex = stops.findIndex(stop => stop.name === fromLocation);
                const toIndex = stops.findIndex(stop => stop.name === toLocation);

                // Determine if user wants to travel in forward or reverse direction
                const userDirection = fromIndex < toIndex ? 'forward' : 'reverse';

                // Fetch available buses
                const response = await fetch(
                    `/api/buses/${busNumber}/active/?from=${encodeURIComponent(fromLocation)}&to=${encodeURIComponent(toLocation)}`,
                    { method: 'GET' }
                );
                const data = await response.json();

                if (!data.buses || data.buses.length === 0) {
                    alert('No buses currently active on this route');
                    return;
                }

                // Filter buses based on user's travel direction
                const relevantBuses = data.buses.filter(bus => {
                    // For forward journey, show forward buses
                    if (fromIndex < toIndex) {
                        return bus.direction === 'forward';
                    }
                    // For reverse journey, show reverse buses
                    else {
                        return bus.direction === 'reverse';
                    }
                });

                if (relevantBuses.length === 0) {
                    alert(`No buses currently moving in your direction. Please check back later.`);
                    return;
                }

                // Show bus selection modal with direction info
                const busListHtml = relevantBuses.map(bus => `
            <div class="bus-option" onclick="selectBus(this, '${bus.id}', '${busNumber}', '${fromLocation}', '${toLocation}')">
                <h6>Bus ${busNumber}</h6>
                <div class="bus-details">
                    <div>Current Location: ${bus.current_location}</div>
                    <div>Last Updated: ${bus.last_updated}</div>
                    <div class="bus-status ${bus.status === 'ON_TIME' ? 'status-ontime' : 'status-delayed'}">
                        ${bus.status === 'ON_TIME' ? 'On Time' : 'Delayed'}
                    </div>
                </div>
                <div class="route-info mt-2">
                    <small class="text-muted">
                        Your Journey: ${fromLocation} ‚Üí ${toLocation}
                    </small>
                </div>
            </div>
        `).join('');

                document.querySelector('.bus-list').innerHTML = `
            <div class="direction-header mb-3">
                <h6 class="text-muted">Available Buses for Your Journey</h6>
                <p class="mb-0">${fromLocation} ‚Üí ${toLocation}</p>
            </div>
            ${busListHtml}
        `;

                const busSelectionModal = new bootstrap.Modal(document.getElementById('busSelectionModal'));
                busSelectionModal.show();

            } catch (error) {
                console.error('Error fetching bus options:', error);
                alert('Error loading bus options. Please try again.');
            }
        }

        function selectBus(element, busId, busNumber, fromLocation, toLocation) {
            // Remove previous selection
            document.querySelectorAll('.bus-option').forEach(opt => opt.classList.remove('selected'));
            // Add selection to clicked element
            element.classList.add('selected');

            // Close selection modal
            bootstrap.Modal.getInstance(document.getElementById('busSelectionModal')).hide();

            // Start tracking the selected bus
            showLiveTracking(busNumber, fromLocation, toLocation, busId);
        }

        async function showLiveTracking(busNumber, fromLocation, toLocation, busId = null) {
            window.notificationShown = false;
            try {
                // Set bus number display
                document.getElementById('busNumberDisplay').textContent = busNumber;

                if (fromLocation && toLocation) {
                    document.getElementById('boardingPoint').textContent = fromLocation;
                    document.getElementById('destinationPoint').textContent = toLocation;
                }

                // Get route data
                const bus = await fetch(`/api/search/`, {
                    method: 'POST',
                    body: new FormData(Object.assign(document.createElement('form'), {
                        innerHTML: `
                            <input name="from" value="${busNumber}">
                            <input name="to" value="track">
                        `
                    }))
                }).then(res => res.json());

                if (!bus.status === 'success' || !bus.routes.length) {
                    throw new Error('Bus route not found');
                }

                const route = bus.routes[0];
                const allStops = route.route_parts[0].stops;

                const fromIndex = allStops.findIndex(stop => stop.name === fromLocation);
                const toIndex = allStops.findIndex(stop => stop.name === toLocation);
                const shouldReverse = fromIndex > toIndex;

                const stops = shouldReverse ? [...allStops].reverse() : allStops;

                const modal = new bootstrap.Modal(document.getElementById('liveTrackingModal'));
                modal.show();

                setTimeout(async () => {
                    if (trackingMap) {
                        trackingMap.remove();
                    }

                    const startPoint = stops[0].coordinates;
                    trackingMap = L.map('trackingMap').setView(startPoint, 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(trackingMap);

                    // Add Driver Controls
                    const controlsDiv = document.createElement('div');
                    controlsDiv.className = 'driver-controls';
                    controlsDiv.innerHTML = `
                        <h6><i class="fas fa-user-tie"></i> Driver Simulation</h6>
                        <button class="btn btn-sm btn-warning mb-2" onclick="toggleSafetyStatus('${busId}', 'manual_stop')">
                            <i class="fas fa-hand-paper"></i> Manual Stop
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="toggleSafetyStatus('${busId}', 'accident')">
                            <i class="fas fa-car-crash"></i> Simulate Accident
                        </button>
                        <button class="btn btn-sm btn-success" onclick="toggleSafetyStatus('${busId}', 'resume')">
                            <i class="fas fa-play"></i> Resume Journey
                        </button>
                        <div class="mt-2 small text-muted">Bus ID: ${busId}</div>
                    `;
                    // Append to map container (overlay)
                    document.getElementById('trackingMap').appendChild(controlsDiv);
                    // Prevent map clicks propagating to controls
                    L.DomEvent.disableClickPropagation(controlsDiv);

                    // Generate path
                    const completePath = [];
                    for (let i = 0; i < stops.length - 1; i++) {
                        const start = stops[i].coordinates;
                        const end = stops[i + 1].coordinates;
                        try {
                            const roadRoute = await getRoadBasedRoute(start, end);
                            completePath.push(...roadRoute);
                        } catch (error) {
                            completePath.push(start, end);
                        }
                    }

                    if (routeLine) trackingMap.removeLayer(routeLine);
                    routeLine = L.polyline(completePath, {
                        color: '#2196F3', weight: 4, opacity: 0.8, lineCap: 'round', lineJoin: 'round'
                    }).addTo(trackingMap);

                    stops.forEach((stop, index) => {
                        const isStart = index === 0;
                        const isEnd = index === stops.length - 1;
                        L.circleMarker(stop.coordinates, {
                            radius: 6,
                            fillColor: isStart ? 'blue' : (isEnd ? 'red' : '#4CAF50'),
                            color: 'white', weight: 2, fillOpacity: 1
                        }).addTo(trackingMap);
                    });

                    // Bus Marker
                    const busIcon = L.divIcon({
                        html: `<div class="bus-icon">üöå</div>`,
                        className: 'bus-marker',
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    });

                    if (busMarker) trackingMap.removeLayer(busMarker);
                    busMarker = L.marker(completePath[0], { icon: busIcon, zIndexOffset: 1000 }).addTo(trackingMap);

                    let currentIndex = 0;
                    if (trackingInterval) clearInterval(trackingInterval);

                    // New Interval Logic separating movement and polling

                    let isPaused = false;

                    // Polling Loop
                    const pollInterval = setInterval(async () => {
                        try {
                            const statusRes = await fetch(`/api/buses/${busNumber}/active/?from=${encodeURIComponent(fromLocation)}&to=${encodeURIComponent(toLocation)}`);
                            const statusData = await statusRes.json();
                            const currentBus = statusData.buses.find(b => b.id === busId);

                            if (currentBus) {
                                const markerEl = busMarker.getElement();
                                if (markerEl) {
                                    if (currentBus.is_manual_stop) {
                                        isPaused = true;
                                        markerEl.classList.add('manual-stop');
                                        if (!busMarker.isTooltipOpen()) busMarker.bindTooltip("üõë Manual Stop by Driver", { permanent: true, direction: "top" }).openTooltip();
                                    } else if (currentBus.is_accident) {
                                        isPaused = true;
                                        markerEl.classList.add('accident');
                                        if (!busMarker.isTooltipOpen()) busMarker.bindTooltip("üö® POSSIBLE ACCIDENT DETECTED", { permanent: true, direction: "top" }).openTooltip();

                                        // Notify all passengers who booked this bus
                                        if (!window.passengersNotified) {
                                            window.passengersNotified = true;
                                            const accidentLocation = busMarker.getLatLng();
                                            notifyAccidentPassengers(busNumber, accidentLocation);
                                        }
                                    } else {
                                        isPaused = false;
                                        markerEl.classList.remove('manual-stop', 'accident');
                                        busMarker.unbindTooltip();

                                        // Reset notification flag when accident is cleared
                                        if (window.passengersNotified) {
                                            window.passengersNotified = false;
                                        }
                                    }
                                }
                            }
                        } catch (e) { console.error(e); }
                    }, 2000);

                    // Animation Loop
                    trackingInterval = setInterval(() => {
                        if (isPaused) return;

                        currentIndex++;
                        if (currentIndex >= completePath.length) {
                            currentIndex = completePath.length - 1;
                            clearInterval(trackingInterval);
                            clearInterval(pollInterval); // Stop polling too
                            return;
                        }
                        busMarker.setLatLng(completePath[currentIndex]);
                        updateStatusPanel(completePath[currentIndex], stops, completePath, currentIndex, true);
                    }, 150);

                    // Cleanup on close
                    document.getElementById('liveTrackingModal').addEventListener('hidden.bs.modal', function () {
                        clearInterval(trackingInterval);
                        clearInterval(pollInterval);
                    });

                    trackingMap.fitBounds(routeLine.getBounds(), { padding: [50, 50] });
                }, 500);

            } catch (error) {
                console.error('Error in live tracking:', error);
            }
        }

        async function toggleSafetyStatus(busId, action) {
            let payload = { bus_id: busId };

            if (action === 'manual_stop') {
                payload.is_manual_stop = true;
                payload.is_accident = false;
                payload.speed = 0;
            } else if (action === 'accident') {
                payload.is_manual_stop = false;
                payload.is_accident = true;
                payload.speed = 0;
                
                // Show confirmation dialog for accident simulation
                const confirmAccident = confirm(
                    "üö® EMERGENCY ACCIDENT SIMULATION üö®\n\n" +
                    "This will:\n" +
                    "‚Ä¢ Change bus status to 'ACCIDENT DETECTED'\n" +
                    "‚Ä¢ Freeze bus at current GPS location\n" +
                    "‚Ä¢ Send emergency emails to:\n" +
                    "  - All passengers with bookings\n" +
                    "  - 40 random family members\n" +
                    "  - Emergency helplines (including vaibhavmevada796@gmail.com)\n\n" +
                    "Continue with accident simulation?"
                );
                
                if (!confirmAccident) {
                    return; // User cancelled
                }
                
            } else if (action === 'resume') {
                payload.is_manual_stop = false;
                payload.is_accident = false;
                payload.speed = 45;
            }

            try {
                const res = await fetch('/api/update-bus-status/', {
                    method: 'POST',
                    body: JSON.stringify(payload),
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();
                
                if (data.status === 'success') {
                    console.log("Status updated");
                    
                    // If accident was triggered, also send emergency notifications
                    if (action === 'accident') {
                        await triggerEmergencyNotifications(busId);
                    }
                } else {
                    alert("Failed to update status");
                }
            } catch (e) {
                console.error(e);
                alert("Error sending command");
            }
        }

        // New function to trigger emergency notifications
        async function triggerEmergencyNotifications(busId) {
            try {
                // Show loading notification
                showCustomNotification(
                    "üö® EMERGENCY SAFETY SYSTEM ACTIVATING",
                    "Sending critical emergency notifications to all contacts",
                    "üö®",
                    "emergency"
                );

                // Extract bus number from busId (e.g., "45-F1" -> "45")
                const busNumber = busId.split('-')[0];
                
                // Get current location from the map or use default coordinates
                let latitude = 23.0225; // Default Ahmedabad coordinates
                let longitude = 72.5714;
                
                // Try to get actual bus location if available
                if (window.currentBusMarker && window.currentBusMarker.getLatLng) {
                    const currentPos = window.currentBusMarker.getLatLng();
                    latitude = currentPos.lat;
                    longitude = currentPos.lng;
                }

                // Prepare emergency data
                const emergencyData = {
                    bus_number: busNumber,
                    accident_location: `Live GPS Location - Bus ${busNumber} Route`,
                    latitude: latitude,
                    longitude: longitude
                };

                console.log('üö® Triggering Emergency System:', emergencyData);

                // Call emergency notification API
                const response = await fetch('/api/emergency-accident/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(emergencyData)
                });

                const result = await response.json();

                if (result.status === 'success') {
                    const emergencyResponse = result.emergency_response;
                    
                    // Show success notification with details
                    showCustomNotification(
                        "‚úÖ EMERGENCY SAFETY SYSTEM ACTIVATED",
                        `${emergencyResponse.notifications_sent} emergency emails sent successfully to all contacts`,
                        "‚úÖ",
                        "success"
                    );

                    // Show detailed alert
                    alert(
                        `üö® EMERGENCY SYSTEM ACTIVATED SUCCESSFULLY! üö®\n\n` +
                        `üìß Total Emails Sent: ${emergencyResponse.notifications_sent}\n` +
                        `üë• Affected Passengers: ${emergencyResponse.affected_passengers}\n` +
                        `üì¢ Broadcast Alerts: ${emergencyResponse.broadcast_alerts_sent || emergencyResponse.family_alerts_sent}\n` +
                        `üö® Helpline Alerts: ${emergencyResponse.helpline_alerts_sent}\n` +
                        `üìç Location: ${emergencyResponse.gps_coordinates}\n` +
                        `üó∫Ô∏è Google Maps: ${emergencyResponse.google_maps_link}\n\n` +
                        `Bus Status: ${emergencyResponse.bus_status}\n` +
                        `Location Frozen: ${emergencyResponse.location_frozen ? 'YES' : 'NO'}\n\n` +
                        `‚úÖ All emergency contacts have been notified!\n` +
                        `üìß Check your Gmail: vaibhavmevada796@gmail.com\n` +
                        `üìß Check test email: cipaha2099@gxuzi.com\n\n` +
                        `üö® Redirecting to Emergency Dashboard...`
                    );

                    console.log('‚úÖ Emergency Response:', result);
                    
                    // Redirect to emergency dashboard after 2 seconds
                    setTimeout(() => {
                        window.location.href = '/emergency-dashboard/';
                    }, 2000);
                    
                } else {
                    throw new Error(result.message || 'Emergency system failed');
                }

            } catch (error) {
                console.error('‚ùå Emergency system error:', error);
                
                showCustomNotification(
                    "‚ùå Emergency System Error",
                    `Failed to send notifications: ${error.message}`,
                    "‚ùå"
                );
                
                alert(
                    `‚ùå EMERGENCY SYSTEM ERROR ‚ùå\n\n` +
                    `Failed to send emergency notifications.\n` +
                    `Error: ${error.message}\n\n` +
                    `Please contact AMTS control room immediately:\n` +
                    `üìû +91-79-2658-0000`
                );
            }
        }

        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Add this after map initialization
        window.addEventListener('resize', () => {
            if (trackingMap) {
                trackingMap.invalidateSize();
            }
        });

        // Also add resize handling to modal events
        document.getElementById('liveTrackingModal').addEventListener('shown.bs.modal', function () {
            setTimeout(() => {
                if (trackingMap) {
                    trackingMap.invalidateSize();
                }
            }, 100);
        });

        // Add this function to handle custom notifications
        function updateStatusPanel(currentPos, stops, completePath, currentIndex, isMovingForward) {
            try {
                // Find nearest stop
                let nearestStop = null;
                let nearestDistance = Infinity;
                let nearestIndex = 0;

                stops.forEach((stop, index) => {
                    const distance = L.latLng(currentPos).distanceTo(L.latLng(stop.coordinates));
                    if (distance < nearestDistance) {
                        nearestDistance = distance;
                        nearestStop = stop;
                        nearestIndex = index;
                    }
                });

                // Update current location without direction arrow
                if (nearestStop) {
                    document.getElementById('currentLocation').textContent = nearestStop.name;
                }

                // Get next stop
                let nextStop = null;
                if (nearestIndex < stops.length - 1) {
                    nextStop = stops[nearestIndex + 1];
                }

                // Get destination stop
                const destinationStop = document.getElementById('destinationPoint').textContent;
                const destinationIndex = stops.findIndex(stop => stop.name === destinationStop);

                // Check if bus is one stop away from destination
                if (Math.abs(nearestIndex - destinationIndex) === 1 && !window.notificationShown) {
                    // Show custom notification
                    showCustomNotification(
                        "üöå Bus Approaching!",
                        `Your bus is one stop away from ${stops[destinationIndex].name}`,
                        "üöå",
                        "warning"
                    );

                    // Also try browser notification as backup
                    if ("Notification" in window) {
                        Notification.requestPermission().then(function (permission) {
                            if (permission === "granted") {
                                new Notification("Bus Approaching!", {
                                    body: "Your bus is one stop away from your destination.",
                                    icon: "/static/bus-icon.png"
                                });
                            }
                        });
                    }

                    window.notificationShown = true;
                }

                // Update next stop info
                if (nextStop) {
                    document.getElementById('nextStop').textContent = nextStop.name;
                    const distanceToNext = L.latLng(currentPos).distanceTo(L.latLng(nextStop.coordinates));
                    const estimatedMinutes = Math.ceil(distanceToNext / 400);
                    document.getElementById('nextStopTime').textContent =
                        `Estimated arrival in ${estimatedMinutes} minutes`;
                } else {
                    document.getElementById('nextStop').textContent = 'Last Stop';
                    document.getElementById('nextStopTime').textContent = '';
                }

                // Update boarding and destination info
                const fromStop = document.getElementById('boardingPoint');
                const toStop = document.getElementById('destinationPoint');

                if (fromStop && toStop) {
                    const fromStopIndex = stops.findIndex(stop => stop.name === fromStop.textContent);
                    const toStopIndex = stops.findIndex(stop => stop.name === toStop.textContent);

                    // Show boarding point status
                    fromStop.parentElement.style.display = 'block';

                    if (nearestIndex === fromStopIndex) {
                        document.getElementById('boardingTime').textContent =
                            'üöå Bus is at your boarding point!';
                        fromStop.style.backgroundColor = 'rgba(40, 167, 69, 0.1)';
                        fromStop.style.borderLeftColor = '#28a745';
                    } else if (nearestIndex < fromStopIndex) {
                        const stopsAway = Math.abs(fromStopIndex - nearestIndex);
                        const estimatedTime = Math.ceil(
                            L.latLng(currentPos).distanceTo(L.latLng(stops[fromStopIndex].coordinates)) / 400
                        );
                        document.getElementById('boardingTime').textContent =
                            `${stopsAway} stop${stopsAway > 1 ? 's' : ''} away (‚âà${estimatedTime} mins)`;
                        fromStop.style.backgroundColor = 'rgba(255, 193, 7, 0.1)';
                        fromStop.style.borderLeftColor = '#ffc107';
                    } else {
                        document.getElementById('boardingTime').textContent =
                            '‚úÖ Bus has passed this stop';
                        fromStop.style.backgroundColor = 'rgba(220, 53, 69, 0.1)';
                        fromStop.style.borderLeftColor = '#dc3545';
                    }

                    // Show destination status
                    toStop.parentElement.style.display = 'block';

                    if (nearestIndex === toStopIndex) {
                        document.getElementById('arrivalTime').textContent =
                            'üèÅ Bus has reached your destination!';
                        toStop.style.backgroundColor = 'rgba(40, 167, 69, 0.1)';
                        toStop.style.borderLeftColor = '#28a745';
                    } else if (nearestIndex < toStopIndex) {
                        const stopsToDestination = Math.abs(toStopIndex - nearestIndex);
                        const estimatedTime = Math.ceil(
                            L.latLng(currentPos).distanceTo(L.latLng(stops[toStopIndex].coordinates)) / 400
                        );
                        document.getElementById('arrivalTime').textContent =
                            `${stopsToDestination} stop${stopsToDestination > 1 ? 's' : ''} away (‚âà${estimatedTime} mins)`;
                        toStop.style.backgroundColor = 'rgba(23, 162, 184, 0.1)';
                        toStop.style.borderLeftColor = '#17a2b8';
                    } else {
                        document.getElementById('arrivalTime').textContent =
                            '‚úÖ Bus has passed your destination';
                        toStop.style.backgroundColor = 'rgba(220, 53, 69, 0.1)';
                        toStop.style.borderLeftColor = '#dc3545';
                    }
                }
            } catch (error) {
                console.error('Error updating status panel:', error);
            }
        }

        // Add this function to handle custom notifications
        function showCustomNotification(title, message, icon, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `custom-notification ${type}`;
            notification.innerHTML = `
        <div class="notification-icon">${icon}</div>
        <div class="notification-content">
            <div class="notification-title">${title}</div>
            <div class="notification-message">${message}</div>
        </div>
        <div class="notification-progress"></div>
    `;

            // Add to document
            document.body.appendChild(notification);

            // Trigger animation
            setTimeout(() => notification.classList.add('show'), 100);

            // Remove after animation (longer for emergency notifications)
            const duration = type === 'emergency' ? 8000 : 5000;
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, duration);

            // Add sound effect (optional)
            const audio = new Audio('/static/notification.mp3');  // Add your notification sound
            audio.play().catch(e => console.log('Audio play failed:', e));
        }

        /**
         * Auto-Track My Bus Feature
         * Automatically fills search form and starts live tracking when coming from booking page
         */
        document.addEventListener('DOMContentLoaded', function () {
            // Check if we have auto-track data from booking page
            const autoTrackData = sessionStorage.getItem('autoTrack');

            if (autoTrackData) {
                console.log('üöå Auto-Track detected!');
                const data = JSON.parse(autoTrackData);
                console.log('Auto-Track Data:', data);

                // Clear the session storage
                sessionStorage.removeItem('autoTrack');

                // Fill in the search form
                const fromInput = document.getElementById('fromLocation');
                const toInput = document.getElementById('toLocation');

                if (fromInput && toInput) {
                    fromInput.value = data.fromStop;
                    toInput.value = data.toStop;

                    console.log('‚úÖ Form filled with:', data.fromStop, '‚Üí', data.toStop);

                    // Automatically trigger search
                    setTimeout(() => {
                        console.log('üîç Auto-clicking search button...');
                        searchBuses(); // Call the existing searchBuses function

                        // After search completes, auto-click Track Live button
                        setTimeout(() => {
                            console.log('üéØ Looking for Track Live button...');

                            // Find the Track Live button for this bus
                            const trackButtons = document.querySelectorAll('.track-live-btn');
                            for (const btn of trackButtons) {
                                if (btn.dataset.busNumber === data.busNumber) {
                                    console.log('‚úÖ Found Track Live button for Bus', data.busNumber, '- clicking...');
                                    btn.click();
                                    break;
                                }
                            }
                        }, 2000); // Wait 2 seconds for search results to render
                    }, 500); // Wait 500ms for page to be ready
                } else {
                    console.error('‚ùå Search form inputs not found');
                    console.log('fromInput:', fromInput);
                    console.log('toInput:', toInput);
                }
            }
        });

        // Function to simulate accident directly from search results
        async function simulateAccidentFromSearch(busNumber) {
            try {
                // Show confirmation dialog
                const confirmAccident = confirm(
                    `üö® EMERGENCY ACCIDENT SIMULATION üö®\n\n` +
                    `Bus: ${busNumber}\n\n` +
                    `This will immediately:\n` +
                    `‚Ä¢ Change bus status to 'ACCIDENT DETECTED'\n` +
                    `‚Ä¢ Freeze bus at current GPS location\n` +
                    `‚Ä¢ Send emergency emails to:\n` +
                    `  - All passengers with bookings on Bus ${busNumber}\n` +
                    `  - ALL registered users (emergency broadcast)\n` +
                    `  - Emergency helplines (including vaibhavmevada796@gmail.com & cipaha2099@gxuzi.com)\n\n` +
                    `‚ö†Ô∏è This will trigger REAL emergency notifications via Gmail SMTP!\n\n` +
                    `Continue with accident simulation?`
                );
                
                if (!confirmAccident) {
                    return; // User cancelled
                }

                // Show loading notification
                showCustomNotification(
                    "üö® EMERGENCY SYSTEM ACTIVATING",
                    `Triggering accident simulation for Bus ${busNumber}`,
                    "üö®",
                    "emergency"
                );

                // Use default Ahmedabad coordinates for simulation
                const emergencyData = {
                    bus_number: busNumber,
                    accident_location: `Emergency Simulation - Bus ${busNumber} Route`,
                    latitude: 23.0225,
                    longitude: 72.5714
                };

                console.log('üö® Triggering Emergency System from Search:', emergencyData);

                // Call emergency notification API
                const response = await fetch('/api/emergency-accident/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(emergencyData)
                });

                const result = await response.json();

                if (result.status === 'success') {
                    const emergencyResponse = result.emergency_response;
                    
                    // Show success notification
                    showCustomNotification(
                        "‚úÖ EMERGENCY SAFETY SYSTEM ACTIVATED",
                        `${emergencyResponse.notifications_sent} emergency emails sent successfully`,
                        "‚úÖ",
                        "success"
                    );

                    // Show detailed success alert
                    alert(
                        `üö® EMERGENCY SYSTEM ACTIVATED SUCCESSFULLY! üö®\n\n` +
                        `Bus ${busNumber} Emergency Response:\n\n` +
                        `üìß Total Emails Sent: ${emergencyResponse.notifications_sent}\n` +
                        `üë• Affected Passengers: ${emergencyResponse.affected_passengers}\n` +
                        `üì¢ Broadcast Alerts: ${emergencyResponse.broadcast_alerts_sent || emergencyResponse.family_alerts_sent}\n` +
                        `üö® Helpline Alerts: ${emergencyResponse.helpline_alerts_sent}\n` +
                        `üìç GPS Location: ${emergencyResponse.gps_coordinates}\n` +
                        `üó∫Ô∏è Google Maps: ${emergencyResponse.google_maps_link}\n\n` +
                        `Bus Status: ${emergencyResponse.bus_status}\n` +
                        `Location Frozen: ${emergencyResponse.location_frozen ? 'YES' : 'NO'}\n\n` +
                        `‚úÖ All emergency contacts have been notified!\n` +
                        `üìß Check your Gmail: vaibhavmevada796@gmail.com\n` +
                        `üìß Check test email: cipaha2099@gxuzi.com\n\n` +
                        `üö® Redirecting to Emergency Dashboard...`
                    );

                    console.log('‚úÖ Emergency Response:', result);
                    
                    // Redirect to emergency dashboard after 2 seconds
                    setTimeout(() => {
                        window.location.href = '/emergency-dashboard/';
                    }, 2000);
                    
                } else {
                    throw new Error(result.message || 'Emergency system failed');
                }

            } catch (error) {
                console.error('‚ùå Emergency system error:', error);
                
                showCustomNotification(
                    "‚ùå Emergency System Error",
                    `Failed to send notifications: ${error.message}`,
                    "‚ùå"
                );
                
                alert(
                    `‚ùå EMERGENCY SYSTEM ERROR ‚ùå\n\n` +
                    `Bus: ${busNumber}\n` +
                    `Failed to send emergency notifications.\n` +
                    `Error: ${error.message}\n\n` +
                    `Please contact AMTS control room immediately:\n` +
                    `üìû Emergency: 108\n` +
                    `üìû AMTS Control: +91-79-2658-0000`
                );
            }
        }

        // Helper function to get CSRF token (if not already defined)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>

</html>